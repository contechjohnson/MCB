# Weekly Analytics Report - Simple Setup

**Status:** ‚úÖ Code Complete
**Architecture:** Vercel API ‚Üí OpenAI ‚Üí Resend Email
**Recipient:** connor@columnline.com (test) ‚Üí forward to Eric

---

## What's Built

‚úÖ `/api/reports/weekly` - Generates report with OpenAI + sends email
‚úÖ `/api/cron/weekly-report` - Automated trigger (runs every Friday 5pm UTC)
‚úÖ Manual trigger support - Test anytime
‚úÖ Week-over-week comparisons
‚úÖ Top ad insights with creative themes
‚úÖ Meta Ads ROAS calculations

---

## Setup Steps (5 minutes)

### 1. Get Resend API Key

1. Go to https://resend.com/
2. Sign up or log in
3. Click "API Keys" in sidebar
4. Click "Create API Key"
5. Name: "MCB Weekly Reports"
6. Copy the key (starts with `re_`)

**Add to `.env.local`:**
```bash
RESEND_API_KEY=re_your_key_here
```

### 2. Verify Domain in Resend (Optional but Recommended)

**Option A: Use postpartumcareusa.com (if you have access)**
1. Go to Resend ‚Üí Domains
2. Add domain: `postpartumcareusa.com`
3. Add DNS records they provide
4. Once verified, emails will show "from: clara@postpartumcareusa.com"

**Option B: Use Resend's test domain**
- Emails will show "from: onboarding@resend.dev"
- Works immediately, no setup needed

### 3. Add Environment Variables to Vercel

1. Go to https://vercel.com/dashboard
2. Select project: `mcb-dun`
3. Go to Settings ‚Üí Environment Variables
4. Add these:

| Name | Value | Environments |
|------|-------|-------------|
| `RESEND_API_KEY` | `re_your_key_here` | Production, Preview, Development |
| `CRON_SECRET` | `8d41e36fa55d605cccbf7e9b621bffe5019c57c5a0b66e5fbda5f5f24b6bf5f1` | Production, Preview, Development |

*Note: CRON_SECRET is already in your `.env.local`, just copy it to Vercel*

### 4. Deploy to Vercel

```bash
git add .
git commit -m "Add weekly analytics email report"
git push origin main
```

Vercel will auto-deploy in ~2 minutes.

---

## Testing (Do This Now!)

### Option 1: Manual Trigger (Immediate Test)

```bash
# Test locally (after adding RESEND_API_KEY to .env.local)
curl "http://localhost:3000/api/reports/weekly?send=true"

# Or test on production after deploying
curl "https://mcb-dun.vercel.app/api/reports/weekly?send=true"
```

**Expected result:**
- Email arrives at connor@columnline.com within 1 minute
- Contains this week's analytics
- Formatted with markdown
- Includes top ads, metrics, recommendations

### Option 2: View Report Without Sending

```bash
# See what the report looks like without sending email
curl "https://mcb-dun.vercel.app/api/reports/weekly"
```

Returns JSON with:
- `report` - The full markdown report text
- `data` - Raw metrics used to generate it

---

## What the Report Includes

**üìä This Week's Numbers:**
- Total contacts
- DM qualification rate
- Attribution coverage
- Meetings booked/held
- Show rate
- Purchases & close rate
- Revenue & ROAS

**üèÜ Top Performing Ads:**
- Ad name
- Contacts generated
- Qualification rate
- Creative theme
- Targeted symptoms

**üìà Week-over-Week Changes:**
- Contact growth
- Revenue growth
- Percentage changes

**üí° Insights & Recommendations:**
- Generated by OpenAI based on the data
- Specific, actionable items
- References top performing creative themes

---

## Automated Schedule

**Current schedule:** Every Friday at 5:00 PM UTC (9am PST)

This is configured in `vercel.json`:
```json
{
  "crons": [{
    "path": "/api/cron/weekly-report",
    "schedule": "0 17 * * 5"
  }]
}
```

**To change the schedule:**
1. Edit `vercel.json`
2. Update the cron expression
3. Deploy to Vercel

**Cron expression examples:**
- `0 17 * * 5` - Every Friday at 5pm UTC
- `0 14 * * 1` - Every Monday at 9am EST (2pm UTC)
- `0 9 * * 1` - Every Monday at 9am UTC

---

## Email Configuration

**Current recipient:** `connor@columnline.com`

**To send to Eric:**

Edit `app/api/reports/weekly/route.ts`, line ~290:

```typescript
// Change from:
to: ['connor@columnline.com'],

// To:
to: ['eric@postpartumcareusa.com'],

// Or CC both:
to: ['connor@columnline.com', 'eric@postpartumcareusa.com'],
```

Then deploy the change.

---

## Troubleshooting

### Email not received

**Check spam folder first!**

**Then check Vercel logs:**
1. Go to Vercel dashboard
2. Select your project
3. Click "Logs" tab
4. Look for errors

**Common issues:**
- Resend API key not set in Vercel
- Domain not verified (if using custom domain)
- Resend account needs to be verified (check email from Resend)

### "Unauthorized" error

CRON_SECRET doesn't match between `.env.local` and Vercel.

**Fix:**
1. Check `.env.local` value
2. Update Vercel environment variable to match
3. Redeploy

### Report generation fails

OpenAI API key issue.

**Fix:**
1. Verify OPENAI_API_KEY is set in Vercel
2. Check OpenAI dashboard for API quota/billing
3. Check Vercel logs for specific error

### No data in report

No contacts/purchases for the week being queried.

**Fix:**
- Normal if testing with past dates
- Try current week: `/api/reports/weekly?send=true` (no week_ending param)

---

## Manual Trigger Anytime

Want to send a report right now (not wait for Friday)?

### Via curl:
```bash
curl "https://mcb-dun.vercel.app/api/reports/weekly?send=true"
```

### Via browser:
Just visit: `https://mcb-dun.vercel.app/api/reports/weekly?send=true`

### For a specific week:
```bash
curl "https://mcb-dun.vercel.app/api/reports/weekly?send=true&week_ending=2025-11-07"
```

---

## Customizing the Report

The report content is controlled by the OpenAI prompt in `app/api/reports/weekly/route.ts`.

**To change report format:**
1. Edit the `REPORT_PROMPT` variable (lines ~26-72)
2. Modify structure, tone, or instructions
3. Deploy and test

**Examples of customizations:**
- Add emoji to section headers
- Change tone (more formal/casual)
- Add/remove sections
- Adjust what metrics to highlight
- Change recommendation format

---

## Cost

**Per report:**
- OpenAI API: ~$0.02 (gpt-4o-mini)
- Resend: Free tier covers 100 emails/day

**Monthly (running weekly):**
- ~$0.08/month (4 reports √ó $0.02)
- Well within free tiers

---

## Next Steps

1. ‚úÖ Get Resend API key
2. ‚úÖ Add to `.env.local`
3. ‚úÖ Add to Vercel env vars
4. ‚úÖ Deploy to Vercel
5. ‚úÖ Send test email: `curl "https://mcb-dun.vercel.app/api/reports/weekly?send=true"`
6. ‚úÖ Check your inbox (connor@columnline.com)
7. ‚úÖ Forward to Eric if it looks good
8. ‚úÖ Change recipient to Eric's email
9. ‚úÖ Deploy again
10. ‚úÖ Done! Reports send automatically every Friday

---

## Quick Reference

**Manual trigger URL:**
```
https://mcb-dun.vercel.app/api/reports/weekly?send=true
```

**View without sending:**
```
https://mcb-dun.vercel.app/api/reports/weekly
```

**Cron endpoint (secured):**
```
https://mcb-dun.vercel.app/api/cron/weekly-report
Authorization: Bearer 8d41e36fa55d605cccbf7e9b621bffe5019c57c5a0b66e5fbda5f5f24b6bf5f1
```

**Files to know:**
- `/app/api/reports/weekly/route.ts` - Main report logic
- `/app/api/cron/weekly-report/route.ts` - Cron trigger
- `/vercel.json` - Cron schedule

---

üéâ **You're all set! The report will automatically send every Friday at 9am PST.**
